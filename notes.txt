next project:
use Dynamic Factor Analysis (related to MARSS, or Dynamic linear models) to predict nutrient concentrations (nitrate, phosphate, N:P ratio) 
based on monthly average air T, monthly average precip, annual snowpack?

Eric, Mark, and Eli wrote the MARSS package, and they can give me the material for the course.  Tim Cline did something similar already, so he can 
give me his code

the idea with Tim's thing (which daniel just presented) was that they modeled stream temperature as a function of air temp and 
snowmelt, and found that some streams were mainly influenced by air temp, and so fluctuated together through time
while other streams were more controlled by snowmelt temperature, and these varied together on a different cycle.  
Gordon doesn't think they had forward predictions with their model, and they also didn't include a term for reduced snowmelt in the future, which would
presumably make streams fluctuate together even more closely.  

so my goal would be to do the same style of model, but add in that term and predict it forward for stream nutrients, which gordon thinks will also be a function
of precipitation (because N just runs right off the landscape, etc.)

tim cline rewrote MARSS in TMB, so it's wicked fast
the idea is that you have different drivers of some response, like stream temp, and some streams are more heavily influences by one subset and other
	streams are influenced by another.  So one function of temp over time might be a parabola and another a sine wave.  those are the two major components that
	come out of the dfa.  then you can look at each stream independently and ask which trend it looks like.  (this is certainly wrong in some ways.)

it will be the residuals after the climate covariates have been included that i will regress against non-climate factors

May, or may not, doesn’t really matter for your analysis.  The goal is simply to find out:
1) are there trends and are they shared among some subset of rivers?
2) Is there a link to climate?  If so, are the climate-linked systems similar in their watershed morphology, glaciers, vegetation, etc…
3) Does the non-climate trends link to thinks like land use, watershed type, etc….

Things to remember for setting up the model fitting loop:
change response var
#DO NOT comment out first call to tmb script
#set transformation type
#redirect loop output and dataframe output to model_outputs_<var> and model_objects_<var>
#change working directory to: setwd("C:/Users/vlahm/Desktop/stream_nuts_DFA/data")
#include or exclude the imputation bit

#changed the transformer function on home version
#changed section 1.1 a lot




#set up meeting with jessica lundquist

#resend draft email to gordon
develop 4-6 figures for the dfa paper. send to gordon. 

write up methods (long-form even if we go for pnas)
then write up results
see jessica before writing intro (before determining the "pitch")
the pitch is either (if jessica says there's something new here):
	1. climate change affects streams and rivers
	2. not all rivers are the same. some are largely rain/snow/both dominated
	3. theoretical models show that... (might get a clue to what gordon was thinking here if i look at the presentation he sent a while back)
	4. ours is the first (that we know of) empirical demonstration of this
or if there's not:
	more hand-wavey
in either case:
	the sussol/turb stuff is not really necessary, and we can just add a few sentences about it.

set up committee meeting for early spring quarter. 
have full draft ready by then, and full presentation (doesnt have to be polished. can be simply: here's chap 1; here's chap 2)
meeting can be about an hour
get all my paperwork squared away by then. get signatures at the meeting
	may need them to sign off and say "yeah, you're good to finish by this date"

set up thesis defense date. find out when daniel is leaving (probably at the end of may)

project the map so it doesnt look weird


#########--------------###########
after lundquist meeting

NOVELTIES: (this is actually pre-lundquist and unverified)

whereas lisi et al found most snow to melt by early summer in their boreal streams, we see that buffering capacity is at its maximum in Jul and Aug, then the 
"catch-up" period begins and goes through october.

there also seems to be an "anti-buffering" effect from nov through apr

we know snowpack will lessen, snowmelt timing will shift, ratio of snowmelt to rain runoff will decrease,
	but now we can show that the buffering capacity of snowpack will shift, so that peak warming will occur
	earlier for streams that are currently snow-dominated.
	
	
TODO:

##figure##
color points by zone? (rain, rain-on-snow, snow)
group together as plots a,b,c, so that i don't have to show the color.legend three times.
will have to specify in the legend that % watershed ice cover is averaged across 2006, 2011, and taken from x data source
say the significant slopes are at 0.1 level
in the by-month plot, change y axis to just "change in water temp"
plots 1 and 2: slopes, r2s on the plot?
combine 1 and 2?
mention that common trend 2 wasnt significant. absorbed error	
figure out what the y axis represents
consider putting elevation on the x axis and coloring by something else

##literature##
beechie+biehl 2008 biological conservation (gordon's suggestion)
Yearsly and Nijssen are the modelers who are most likely to have done our thing already - backed up the models with data
dan moore does this stuff too
chris franz - aug-sept should be the most important months for buffering??
iris stewart - identified the center of mass shift in the hydrograph
check CIG 2009 (jessica's email) and probably other CIG reports too, to see if this has already been done

##other##
ave watershed slope should be included as a landscape variable?
instead of elevation, use percent of watershed area above 3000 feet, e.g.
compose monthly at best, yearly at worst time series of snowfall (or snow depth by year) and discharge
	nrcs snowtel data
	CIG reports may also link to snow data
	here's what i'll use for snow: snowpack last month-snowpath this month (but only accept positive differences - the rest are assigned 0)
include the loadings regression as corroboration of the effect size regression. the idea is, air temp drives stream temp, but if it doesn't here's why (snowmelt)
	and here's the hidden trend to describe the rivers that dont follow suit.
	
gordon meeting 1/25/17:
	must get monthly breakout to have same y axis as effect size plot. i.e. gotta find coupling by month, or more likely by season
	see if this can be done under the current setup. if not, run separate dfas by season.
	include temperature and total precip as covariates, then
		do post-hoc regression of either:
			1) change in discharge vs. % ice or total area above 3000 ft for rising limb of hydrograph and falling limb/flat period (late summer, early fall)
				make sure this synchs up with cluster analysis of best seasons before using those seasons.
			2) separate regression of change in temp versus % ice or total area above 3000 ft 
			OR
			1) multiple regression including discharge and snow as predictors of temp
		may also have to run a separate dfa to figure out what discharge trends exist